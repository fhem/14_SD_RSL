name: CI

on: [push]

jobs:

  build:
    env:
      CONTROLS_FILENAME: controls_rsl.txt 
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: update controls files
      run: |
        rm -f  ${CONTROLS_FILENAME}
        while IFS= read -r -d '' FILE
        do
           TIME=$(git log --pretty=format:%cd -n 1 --date=format:%Y-%m-%d\ %H:%M -- "$FILE")
           FILESIZE=$(stat -c%s "$FILE")
           FILE=$(echo "$FILE"  | cut -c 3-)
           printf "UPD %s %-7d %s\n" "$TIME" "$FILESIZE" "$FILE"  >> ${CONTROLS_FILENAME}
        done <   <(find ./FHEM -maxdepth 2 \( -name "*.pm" \) -print0 | sort -z -g)
    - name: update CHANGED
      run: |
        echo $(date +"%Y-%m-%d") >> CHANGED
        echo " - $(git log -1 --pretty=%B)" >> CHANGED
    - name: git commit back
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.email "update@github-actions.com"
        git config --global user.name "Updater"
        git config --global push.default simple
        git remote set-url origin https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
        git add  CHANGED ${CONTROLS_FILENAME} && git commit  CHANGED ${CONTROLS_FILENAME} -m "Automaitc updated controls and CHANGED" || true
    - name: git push
      run: |
        git push origin HEAD:${GITHUB_REF}     
